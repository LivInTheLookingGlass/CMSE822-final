
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 2D Advection Equation
// Carolyn Wendeln
// 12/03/2021
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include <iostream>
#include <fstream>
#include <string>
#include <cmath>
#include<chrono>
#include<ctime>

using std::cout; using std::endl;
using std::chrono::nanoseconds;
using std::to_string;
using namespace std;

//at + (ua)x + (va)y = 0

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Output Array Functions
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void print_array(double** arr, int N, double* x_dist, double* y_dist) 
{ 
	//cout << " x " << " y " << " a_write " << endl;
	for (int i = 0; i < N; i++)
	{
		for (int j = 0; j < N; j++)
		{
			cout << x_dist[i] << " " << y_dist[j] << " " << arr[i][j] << endl; 
		}
	}
} 

void output_array(double** arr, int N, int n, double* x_dist, double* y_dist)
{
    ofstream file;
    string file_name = "2D_time_step_" + to_string(n) + ".csv";
    file.open (file_name);
    file << "x dist" << " ," << "y dist" << " ,"<< "func value" << endl;
    if (file.is_open())
    {
  		for (int i = 0; i < N; i++)
  		{
  			for (int j = 0; j < N; j++)
  			{
  				file << x_dist[i] << " ," << y_dist[j] << " ," << arr[i][j] << endl;
  			}
  		}
  	file.close();
    }
    else cout << "can not open a file";
}


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Main Function
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int main () {

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//Input Data
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	// Matrix Size
	double dist_start = 0;
	double dist_end = 1;
	int N = 10;
	double delta_dist = (dist_end-dist_start) / (N-1);

	// Time Step
	double t_start = 0;
	double t_end = 10;
	int n = 40;
	double delta_t = (t_end-t_start) / (n-1);

	// Velocity
	double u = 0.1;

	// Cache Block Size
	double blockSize = 3;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//Generate Arrays
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	  

	double* x_dist = new double[N];
	double* y_dist = new double[N];

	double** a_read = new double*[N];
	double** a_write = new double*[N];

	double** temp;

	for(int i = 0; i < N; ++i)
	{
    	a_read[i] = new double[N];
    	a_write[i] = new double[N];
	}

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//Initialize Arrays
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  	for(int i=0; i<(N); ++i)
  	{
  		x_dist[i] = dist_start + delta_dist * i;
  		y_dist[i] = dist_start + delta_dist * i;
  	}


  	// Initial condition
	for(int i=0; i<(N-1); ++i)
  	{
  		for(int j=0; j<(N-1); ++j)
  		{
  			a_read[i][j] = exp(-1 * (pow(x_dist[i] - 0.5,2) + pow(y_dist[j] - 0.5,2)) * 50.0);
  		}
 	 }


	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//Apply Advection Equation
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

 	//loop through time steps
 	for(int t=0; t<n; ++t)
 	{
 		
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//four corners
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	  	//i = 0  ; j = 0
	  	a_write[0][0] = a_read[0][0] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[1][0] - a_read[N-1][0])) + ((a_read[0][1] - a_read[0][N-1]))));

		//i = 0  ; j = 99
	  	a_write[0][N-1] = a_read[0][N-1] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[1][N-1] - a_read[N-1][N-1])) + ((a_read[0][0] - a_read[0][N-2]))));

		//i = 99 ; j = 0
		 a_write[N-1][0] = a_read[N-1][0] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[0][0] - a_read[N-2][0])) + ((a_read[N-1][1] - a_read[N-1][N-1]))));

		//i = 99 ; j = 99
	  	a_write[N-1][N-1] = a_read[N-1][N-1] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[0][N-1] - a_read[N-2][N-1])) + ((a_read[N-1][0] - a_read[N-1][N-2]))));
		
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//first few cases
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	 	 //loop along first row
	 	for(int j=1; j<(N-2); ++j)
	 	{
	  		a_write[0][j] = a_read[0][j] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[1][j] - a_read[N-1][j])) + ((a_read[0][j+1] - a_read[0][j-1]))));
	 	}

	 	//loop along first column
		for(int i=1; i<(N-2); ++i)
		{
	  		a_write[i][0] = a_read[i][0] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[i+1][0] - a_read[i-1][0])) + ((a_read[i][1] - a_read[i][N-1]))));
		}

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//bulk
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

		using duration = nanoseconds;
   		auto t1 = std::chrono::steady_clock::now();

		for(int row=1; row<(N-2); row+=blockSize)
	  	{
    		cout << "row " << row << endl;

	  		for(int col=1; col<(N-2); col+=blockSize)
	  		{
	  			cout << "col " << col << endl;

				for(int blockRow=row; blockRow<(row+blockSize); ++blockRow)
				{
					cout << "blockRow " << col << endl;

					for(int blockCol=col; blockCol<(col+blockSize); ++blockCol)
					{
	  					cout << "blockCol " << col << endl;

	  					a_write[blockRow][blockCol] = a_read[blockRow][blockCol] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[blockRow+1][blockCol] - a_read[blockRow-1][blockCol])) + ((a_read[blockRow][blockCol+1] - a_read[blockRow][blockCol-1]))));

					}

				}

	  		}
	  	}

	  	auto t2 = std::chrono::steady_clock::now();
    	auto elapsed_time=std::chrono::duration_cast<duration>(t2-t1).count();
    
    	cout << "Elapsed time is " << elapsed_time << " nanoseconds."<<'\n'; //getting the time of each trial
    

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//last few cases
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

		//loop along last row
	 	for(int j=1; j<(N-2); ++j)
	 	{
	  		a_write[N-1][j] = a_read[N-1][j] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[0][j] - a_read[N-2][j])) + ((a_read[N-1][j+1] - a_read[N-1][j-1]))));
	 	}

	 	//loop along last column
		for(int i=1; i<(N-2); ++i)
		{
	  		a_write[i][N-1] = a_read[i][N-1] - ((((u * delta_t) / (2 * delta_dist))) * (((a_read[i+1][N-1] - a_read[i-1][N-1])) + ((a_read[i][0] - a_read[i][N-2]))));
		}

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//swap arrays & output
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        temp = a_read;
        a_read = a_write;
        a_write = temp;

		//output_array(a_write, N, t, x_dist, y_dist);

	}


	for(int i = 0; i < N; ++i) 
	{
    	delete [] a_read[i];
    	delete [] a_write[i];
	}

	delete [] x_dist;
	delete [] y_dist;

    delete [] a_read;
	delete [] a_write;

}


